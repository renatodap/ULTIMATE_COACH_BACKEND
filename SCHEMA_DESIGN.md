# SHARPENED Backend - Database Schema Design

> **Visual Database Architecture** - Complete system overview with relationships

---

## ğŸ¯ Schema Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SHARPENED BACKEND SCHEMA                         â”‚
â”‚                                                                          â”‚
â”‚  Core Systems:                                                           â”‚
â”‚  â”œâ”€ ğŸ‘¤ User Management (auth, profiles, onboarding)                     â”‚
â”‚  â”œâ”€ ğŸ’¬ AI Consultation (keys, sessions, extracted data)                 â”‚
â”‚  â”œâ”€ ğŸ“‹ Program Generation (programs, sessions, meals)                   â”‚
â”‚  â”œâ”€ ğŸ“… Daily Planning (calendar, overrides, adherence)                  â”‚
â”‚  â”œâ”€ ğŸ½ï¸  Nutrition Tracking (meals, foods, quick meals)                  â”‚
â”‚  â””â”€ ğŸ’ª Activity Tracking (activities, templates, exercise sets)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Core Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                          â”‚
â”‚                              auth.users                                  â”‚
â”‚                           (Supabase Auth)                                â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                         â”‚  id (UUID)   â”‚                                 â”‚
â”‚                         â”‚  email       â”‚                                 â”‚
â”‚                         â”‚  created_at  â”‚                                 â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                â”‚                                         â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                    â”‚           â”‚                   â”‚                    â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚   profiles   â”‚  â”‚ consultationâ”‚  â”‚   programs    â”‚             â”‚
â”‚         â”‚              â”‚  â”‚   sessions  â”‚  â”‚               â”‚             â”‚
â”‚         â”‚ â€¢ demographicsâ”‚  â”‚             â”‚  â”‚ â€¢ immutable   â”‚             â”‚
â”‚         â”‚ â€¢ goals      â”‚  â”‚ â€¢ progress  â”‚  â”‚ â€¢ versioned   â”‚             â”‚
â”‚         â”‚ â€¢ preferencesâ”‚  â”‚ â€¢ state     â”‚  â”‚ â€¢ full_bundle â”‚             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                 â”‚                   â”‚                    â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
â”‚                    â”‚            â”‚                   â”‚                    â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚         â”‚ consultation_  â”‚  â”‚  session_   â”‚  â”‚  meal_         â”‚         â”‚
â”‚         â”‚ keys/usage     â”‚  â”‚  instances  â”‚  â”‚  instances     â”‚         â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                    â”‚                 â”‚                   â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚                         â”‚          â”‚                 â”‚                   â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚              â”‚ exercise_planâ”‚  â”‚  calendar_  â”‚  â”‚ meal_item_   â”‚        â”‚
â”‚              â”‚ _items       â”‚  â”‚  events     â”‚  â”‚ plan         â”‚        â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                       â”‚                                  â”‚
â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                            â”‚          â”‚          â”‚                       â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚                  â”‚ adherence_  â”‚  â”‚  day_  â”‚  â”‚ plan_      â”‚            â”‚
â”‚                  â”‚ records     â”‚  â”‚overrideâ”‚  â”‚ change_    â”‚            â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ events     â”‚            â”‚
â”‚                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© System Breakdown

### 1ï¸âƒ£ User Management System

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      USER MANAGEMENT                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  auth.users (Supabase)                                           â”‚
â”‚  â””â”€â–º profiles                                                    â”‚
â”‚       â”œâ”€ Demographics: age, sex, height, weight                  â”‚
â”‚       â”œâ”€ Goals: primary_goal, experience_level                   â”‚
â”‚       â”œâ”€ Activity: workout_frequency, activity_level             â”‚
â”‚       â”œâ”€ Nutrition: dietary_preference, meals_per_day            â”‚
â”‚       â”œâ”€ Targets: daily_calorie_goal, protein/carbs/fat          â”‚
â”‚       â””â”€ Flags: onboarding_completed, consultation_completed     â”‚
â”‚                                                                  â”‚
â”‚  Key Fields:                                                     â”‚
â”‚  â€¢ id (FK â†’ auth.users.id)                                       â”‚
â”‚  â€¢ onboarding_completed (boolean)                                â”‚
â”‚  â€¢ consultation_completed (boolean)                              â”‚
â”‚  â€¢ estimated_tdee, daily_calorie_goal                            â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2ï¸âƒ£ AI Consultation System

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AI CONSULTATION FLOW                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  Step 1: Key Validation                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ consultation_keys  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ consultation_key_   â”‚                â”‚
â”‚  â”‚                    â”‚         â”‚ usage               â”‚                â”‚
â”‚  â”‚ â€¢ key_value        â”‚         â”‚                     â”‚                â”‚
â”‚  â”‚ â€¢ max_uses         â”‚         â”‚ â€¢ ip_address        â”‚                â”‚
â”‚  â”‚ â€¢ expires_at       â”‚         â”‚ â€¢ user_agent        â”‚                â”‚
â”‚  â”‚ â€¢ assigned_user_id â”‚         â”‚ â€¢ redeemed_at       â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                          â”‚
â”‚  Step 2: Conversation Session                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ consultation_sessions    â”‚                                           â”‚
â”‚  â”‚                          â”‚                                           â”‚
â”‚  â”‚ â€¢ session_id (UUID)      â”‚                                           â”‚
â”‚  â”‚ â€¢ user_id                â”‚                                           â”‚
â”‚  â”‚ â€¢ consultation_key       â”‚                                           â”‚
â”‚  â”‚ â€¢ current_section (1-7)  â”‚                                           â”‚
â”‚  â”‚ â€¢ progress_percentage    â”‚                                           â”‚
â”‚  â”‚ â€¢ completed_at           â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚               â”‚                                                          â”‚
â”‚               â”œâ”€â”€â–º consultation_messages (chat history)                 â”‚
â”‚               â”‚                                                          â”‚
â”‚               â””â”€â”€â–º Extracted Data Tables (9 tables):                    â”‚
â”‚                    â”œâ”€ user_training_modalities                          â”‚
â”‚                    â”œâ”€ user_familiar_exercises                           â”‚
â”‚                    â”œâ”€ user_training_availability                        â”‚
â”‚                    â”œâ”€ user_preferred_meal_times                         â”‚
â”‚                    â”œâ”€ user_typical_meal_foods                           â”‚
â”‚                    â”œâ”€ user_improvement_goals                            â”‚
â”‚                    â”œâ”€ user_difficulties                                 â”‚
â”‚                    â”œâ”€ user_non_negotiables                              â”‚
â”‚                    â””â”€ user_upcoming_events                              â”‚
â”‚                                                                          â”‚
â”‚  Step 3: Program Generation Trigger                                     â”‚
â”‚  consultation_sessions.completed_at = NOW()                             â”‚
â”‚  â””â”€â”€â–º POST /consultation/{session_id}/complete                          â”‚
â”‚        â””â”€â”€â–º generate_program_from_consultation()                        â”‚
â”‚             â””â”€â”€â–º store in programs table                                â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3ï¸âƒ£ Program Generation & Storage

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PROGRAM GENERATION SYSTEM                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  Input Source: Consultation OR Onboarding                               â”‚
â”‚  Generator: ultimate_ai_consultation/api/generate_program.py            â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚              programs (immutable)                â”‚                   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                   â”‚
â”‚  â”‚  â€¢ id (UUID)                                     â”‚                   â”‚
â”‚  â”‚  â€¢ user_id                                       â”‚                   â”‚
â”‚  â”‚  â€¢ primary_goal                                  â”‚                   â”‚
â”‚  â”‚  â€¢ program_start_date                            â”‚                   â”‚
â”‚  â”‚  â€¢ program_duration_weeks (2, 12, etc.)          â”‚                   â”‚
â”‚  â”‚  â€¢ next_reassessment_date                        â”‚                   â”‚
â”‚  â”‚                                                  â”‚                   â”‚
â”‚  â”‚  JSONB Fields:                                   â”‚                   â”‚
â”‚  â”‚  â€¢ tdee: {tdee_kcal, bmr_kcal, multiplier}      â”‚                   â”‚
â”‚  â”‚  â€¢ macros: {protein_g, carbs_g, fat_g}          â”‚                   â”‚
â”‚  â”‚  â€¢ safety: {warnings[], constraints[]}           â”‚                   â”‚
â”‚  â”‚  â€¢ feasibility: {score, issues[]}                â”‚                   â”‚
â”‚  â”‚  â€¢ full_bundle: complete ProgramBundle           â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                       â”‚                                                  â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚         â”‚             â”‚                 â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ session_     â”‚  â”‚ meal_      â”‚  â”‚ calendar_    â”‚                    â”‚
â”‚  â”‚ instances    â”‚  â”‚ instances  â”‚  â”‚ events       â”‚                    â”‚
â”‚  â”‚              â”‚  â”‚            â”‚  â”‚              â”‚                    â”‚
â”‚  â”‚ â€¢ week_index â”‚  â”‚ â€¢ week_idx â”‚  â”‚ (denormalizedâ”‚                    â”‚
â”‚  â”‚ â€¢ day_index  â”‚  â”‚ â€¢ day_idx  â”‚  â”‚  view)       â”‚                    â”‚
â”‚  â”‚ â€¢ session_   â”‚  â”‚ â€¢ meal_    â”‚  â”‚              â”‚                    â”‚
â”‚  â”‚   kind       â”‚  â”‚   type     â”‚  â”‚ â€¢ date       â”‚                    â”‚
â”‚  â”‚ â€¢ duration   â”‚  â”‚ â€¢ totals   â”‚  â”‚ â€¢ ref_table  â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚ â€¢ ref_id     â”‚                    â”‚
â”‚         â”‚                 â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  â”‚ exercise_    â”‚  â”‚ meal_item_ â”‚                                       â”‚
â”‚  â”‚ plan_items   â”‚  â”‚ plan       â”‚                                       â”‚
â”‚  â”‚              â”‚  â”‚            â”‚                                       â”‚
â”‚  â”‚ â€¢ order      â”‚  â”‚ â€¢ food_    â”‚                                       â”‚
â”‚  â”‚ â€¢ name       â”‚  â”‚   name     â”‚                                       â”‚
â”‚  â”‚ â€¢ sets/reps  â”‚  â”‚ â€¢ serving  â”‚                                       â”‚
â”‚  â”‚ â€¢ rest_sec   â”‚  â”‚ â€¢ targets  â”‚                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                                          â”‚
â”‚  Storage Service: ProgramStorageService                                 â”‚
â”‚  â””â”€â–º store_program_bundle()                                             â”‚
â”‚       â”œâ”€ Creates programs row                                           â”‚
â”‚       â”œâ”€ Creates session_instances (N rows)                             â”‚
â”‚       â”œâ”€ Creates exercise_plan_items (M rows)                           â”‚
â”‚       â”œâ”€ Creates meal_instances (P rows)                                â”‚
â”‚       â”œâ”€ Creates meal_item_plan (Q rows)                                â”‚
â”‚       â””â”€ Creates calendar_events (R rows, denormalized)                 â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 4ï¸âƒ£ Daily Planning & Adaptive System

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ADAPTIVE PLANNING SYSTEM                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  Daily Flow:                                                             â”‚
â”‚                                                                          â”‚
â”‚  1. User logs context                                                   â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚     â”‚ user_context_log    â”‚                                             â”‚
â”‚     â”‚                     â”‚                                             â”‚
â”‚     â”‚ â€¢ date              â”‚                                             â”‚
â”‚     â”‚ â€¢ sleep_hours       â”‚                                             â”‚
â”‚     â”‚ â€¢ sleep_quality     â”‚                                             â”‚
â”‚     â”‚ â€¢ stress_level      â”‚                                             â”‚
â”‚     â”‚ â€¢ soreness_level    â”‚                                             â”‚
â”‚     â”‚ â€¢ energy_level      â”‚                                             â”‚
â”‚     â”‚ â€¢ injury_notes      â”‚                                             â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚                â”‚                                                         â”‚
â”‚  2. System analyzes triggers                                            â”‚
â”‚                â”‚                                                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚     â”‚ DailyAdjustmentService.analyze_and_adjust() â”‚                     â”‚
â”‚     â”‚                                              â”‚                     â”‚
â”‚     â”‚ Checks:                                      â”‚                     â”‚
â”‚     â”‚ â€¢ Poor sleep (< 6 hours or quality < 5)     â”‚                     â”‚
â”‚     â”‚ â€¢ High stress (> 7/10)                       â”‚                     â”‚
â”‚     â”‚ â€¢ High soreness (> 7/10)                     â”‚                     â”‚
â”‚     â”‚ â€¢ Injury (injury_notes present)              â”‚                     â”‚
â”‚     â”‚ â€¢ Low adherence (< 70% completion)           â”‚                     â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                â”‚                                                         â”‚
â”‚  3. Creates adjustment                                                  â”‚
â”‚                â”‚                                                         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚     â”‚ day_overrides       â”‚                                             â”‚
â”‚     â”‚                     â”‚                                             â”‚
â”‚     â”‚ â€¢ date              â”‚                                             â”‚
â”‚     â”‚ â€¢ reason_code       â”‚                                             â”‚
â”‚     â”‚ â€¢ modifications:    â”‚                                             â”‚
â”‚     â”‚   {                 â”‚                                             â”‚
â”‚     â”‚     calorie_adj: -200,                                            â”‚
â”‚     â”‚     volume_adj: -2,                                               â”‚
â”‚     â”‚     intensity: 0.8                                                â”‚
â”‚     â”‚   }                 â”‚                                             â”‚
â”‚     â”‚ â€¢ status (pending/  â”‚                                             â”‚
â”‚     â”‚   approved/rejected)â”‚                                             â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚                                                                          â”‚
â”‚  4. User approves/rejects                                               â”‚
â”‚     â””â”€â–º AdjustmentApprovalService                                       â”‚
â”‚         â”œâ”€ approve_adjustment()                                         â”‚
â”‚         â”œâ”€ reject_adjustment()                                          â”‚
â”‚         â””â”€ undo_adjustment()                                            â”‚
â”‚                                                                          â”‚
â”‚  5. Track adherence                                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                             â”‚
â”‚     â”‚ adherence_records   â”‚                                             â”‚
â”‚     â”‚                     â”‚                                             â”‚
â”‚     â”‚ â€¢ planned_entity_   â”‚                                             â”‚
â”‚     â”‚   type (session/    â”‚                                             â”‚
â”‚     â”‚   meal)             â”‚                                             â”‚
â”‚     â”‚ â€¢ status (completed/â”‚                                             â”‚
â”‚     â”‚   similar/skipped)  â”‚                                             â”‚
â”‚     â”‚ â€¢ similarity_score  â”‚                                             â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                             â”‚
â”‚                                                                          â”‚
â”‚  6. Bi-weekly reassessment                                              â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚     â”‚ ReassessmentService              â”‚                                â”‚
â”‚     â”‚                                  â”‚                                â”‚
â”‚     â”‚ Every 14 days:                   â”‚                                â”‚
â”‚     â”‚ 1. Aggregate adherence data      â”‚                                â”‚
â”‚     â”‚ 2. Calculate weight change       â”‚                                â”‚
â”‚     â”‚ 3. Run PID controllers:          â”‚                                â”‚
â”‚     â”‚    â€¢ CaloriePIDController        â”‚                                â”‚
â”‚     â”‚    â€¢ VolumePIDController         â”‚                                â”‚
â”‚     â”‚ 4. Determine adjustments         â”‚                                â”‚
â”‚     â”‚ 5. Create plan_change_events     â”‚                                â”‚
â”‚     â”‚ 6. Update program targets        â”‚                                â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 5ï¸âƒ£ User Activity Tracking

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ACTIVITY TRACKING                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚ activities           â”‚                                        â”‚
â”‚  â”‚                      â”‚                                        â”‚
â”‚  â”‚ â€¢ user_id            â”‚                                        â”‚
â”‚  â”‚ â€¢ category:          â”‚                                        â”‚
â”‚  â”‚   - cardio_steady    â”‚                                        â”‚
â”‚  â”‚   - cardio_interval  â”‚                                        â”‚
â”‚  â”‚   - strength         â”‚                                        â”‚
â”‚  â”‚   - sports           â”‚                                        â”‚
â”‚  â”‚   - flexibility      â”‚                                        â”‚
â”‚  â”‚ â€¢ start_time         â”‚                                        â”‚
â”‚  â”‚ â€¢ end_time           â”‚                                        â”‚
â”‚  â”‚ â€¢ duration_minutes   â”‚                                        â”‚
â”‚  â”‚ â€¢ calories_burned    â”‚                                        â”‚
â”‚  â”‚ â€¢ intensity_mets     â”‚                                        â”‚
â”‚  â”‚                      â”‚                                        â”‚
â”‚  â”‚ â€¢ metrics (JSONB):   â”‚                                        â”‚
â”‚  â”‚   Cardio: {distance, â”‚                                        â”‚
â”‚  â”‚            pace, hr} â”‚                                        â”‚
â”‚  â”‚   Strength: {        â”‚                                        â”‚
â”‚  â”‚     exercises[]      â”‚                                        â”‚
â”‚  â”‚   }                  â”‚                                        â”‚
â”‚  â”‚   Sports: {sport,    â”‚                                        â”‚
â”‚  â”‚            score}    â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚           â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚  â”‚ exercise_sets       â”‚                                         â”‚
â”‚  â”‚                     â”‚                                         â”‚
â”‚  â”‚ â€¢ activity_id       â”‚                                         â”‚
â”‚  â”‚ â€¢ exercise_name     â”‚                                         â”‚
â”‚  â”‚ â€¢ set_number        â”‚                                         â”‚
â”‚  â”‚ â€¢ reps              â”‚                                         â”‚
â”‚  â”‚ â€¢ weight_kg         â”‚                                         â”‚
â”‚  â”‚ â€¢ rpe               â”‚                                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚  â”‚ activity_templates  â”‚                                         â”‚
â”‚  â”‚                     â”‚                                         â”‚
â”‚  â”‚ â€¢ user_id           â”‚                                         â”‚
â”‚  â”‚ â€¢ template_name     â”‚                                         â”‚
â”‚  â”‚ â€¢ category          â”‚                                         â”‚
â”‚  â”‚ â€¢ template_data     â”‚                                         â”‚
â”‚  â”‚   (JSONB)           â”‚                                         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 6ï¸âƒ£ Nutrition Tracking

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     NUTRITION TRACKING                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚ foods        â”‚  â† Shared food database                        â”‚
â”‚  â”‚              â”‚                                                â”‚
â”‚  â”‚ â€¢ name       â”‚                                                â”‚
â”‚  â”‚ â€¢ brand      â”‚                                                â”‚
â”‚  â”‚ â€¢ servings[] â”‚                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚         â”‚                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ custom_foods     â”‚       â”‚ quick_meals     â”‚                 â”‚
â”‚  â”‚                  â”‚       â”‚                 â”‚                 â”‚
â”‚  â”‚ â€¢ user_id        â”‚       â”‚ â€¢ user_id       â”‚                 â”‚
â”‚  â”‚ â€¢ name           â”‚       â”‚ â€¢ meal_name     â”‚                 â”‚
â”‚  â”‚ â€¢ nutrition      â”‚       â”‚ â€¢ total_cals    â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â€¢ components[]  â”‚                 â”‚
â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  â”‚ meals            â”‚  â† User meal logs                          â”‚
â”‚  â”‚                  â”‚                                            â”‚
â”‚  â”‚ â€¢ user_id        â”‚                                            â”‚
â”‚  â”‚ â€¢ logged_at      â”‚                                            â”‚
â”‚  â”‚ â€¢ meal_type      â”‚                                            â”‚
â”‚  â”‚ â€¢ foods[]        â”‚                                            â”‚
â”‚  â”‚ â€¢ total_cals     â”‚                                            â”‚
â”‚  â”‚ â€¢ total_protein  â”‚                                            â”‚
â”‚  â”‚ â€¢ total_carbs    â”‚                                            â”‚
â”‚  â”‚ â€¢ total_fat      â”‚                                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”— Key Relationships

### Primary Foreign Keys

```
profiles.id               â†’ auth.users.id
consultation_sessions     â†’ auth.users.id
programs                  â†’ auth.users.id
session_instances         â†’ programs.id
exercise_plan_items       â†’ session_instances.id
meal_instances            â†’ programs.id
meal_item_plan            â†’ meal_instances.id
calendar_events           â†’ programs.id + auth.users.id
day_overrides             â†’ programs.id + auth.users.id
adherence_records         â†’ auth.users.id
plan_change_events        â†’ programs.id + auth.users.id
activities                â†’ auth.users.id
meals                     â†’ auth.users.id
```

### Soft References (UUID strings in JSONB or TEXT)

```
calendar_events.ref_id    â†’ session_instances.id OR meal_instances.id
adherence_records         â†’ session_instances.id OR meal_instances.id
                            (via planned_entity_id)
```

---

## ğŸ“‹ Table Summary

| **Category** | **Tables** | **Purpose** |
|-------------|-----------|-------------|
| **Auth & Profile** | `auth.users`, `profiles` | User accounts and demographics |
| **Consultation** | `consultation_keys`, `consultation_key_usage`, `consultation_sessions`, `consultation_messages`, `user_training_modalities`, `user_familiar_exercises`, `user_training_availability`, `user_preferred_meal_times`, `user_typical_meal_foods`, `user_improvement_goals`, `user_difficulties`, `user_non_negotiables`, `user_upcoming_events` | AI consultation system (13 tables) |
| **Program Storage** | `programs`, `session_instances`, `exercise_plan_items`, `meal_instances`, `meal_item_plan` | Generated programs and plan instances |
| **Planning** | `calendar_events`, `day_overrides`, `adherence_records`, `plan_change_events`, `user_context_log`, `notifications` | Adaptive planning and adjustments |
| **Activity Tracking** | `activities`, `exercise_sets`, `activity_templates` | User workout logs |
| **Nutrition Tracking** | `foods`, `custom_foods`, `meals`, `quick_meals` | User meal logs |
| **Supporting** | `exercises`, `training_modalities`, `meal_times`, `event_types` | Reference data |

**Total Tables: ~38 tables**

---

## ğŸ¨ Data Flow: End-to-End

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         USER JOURNEY                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. SIGNUP
   â””â”€â–º auth.users created
       â””â”€â–º profiles created

2. ONBOARDING
   â””â”€â–º profiles updated (all demographic + goal fields)
       â””â”€â–º onboarding_completed = true

3A. OPTION A: Start using app (without consultation)
    â””â”€â–º Log meals â†’ meals table
    â””â”€â–º Log activities â†’ activities table
    â””â”€â–º Chat with AI coach â†’ coach_conversations + coach_messages

3B. OPTION B: AI Consultation (premium)
    â””â”€â–º Enter consultation key â†’ consultation_keys validated
        â””â”€â–º Start session â†’ consultation_sessions created
            â””â”€â–º Multi-turn conversation â†’ consultation_messages
                â””â”€â–º Extract structured data â†’ 9 user_* tables
                    â””â”€â–º Complete consultation â†’ programs generated
                        â”œâ”€â–º session_instances created
                        â”œâ”€â–º exercise_plan_items created
                        â”œâ”€â–º meal_instances created
                        â”œâ”€â–º meal_item_plan created
                        â””â”€â–º calendar_events created

4. DAILY USAGE
   â””â”€â–º View today's plan â†’ calendar_events
       â”œâ”€â–º Complete workout â†’ activities + adherence_records
       â”œâ”€â–º Log meals â†’ meals + adherence_records
       â””â”€â–º Log context â†’ user_context_log
           â””â”€â–º Trigger adjustments â†’ day_overrides

5. BI-WEEKLY REASSESSMENT
   â””â”€â–º ReassessmentService runs
       â”œâ”€â–º Aggregate adherence_records
       â”œâ”€â–º Calculate weight change (body_metrics)
       â”œâ”€â–º Run PID controllers
       â”œâ”€â–º Create plan_change_events
       â””â”€â–º Update programs.next_reassessment_date

6. CONTINUOUS ADAPTATION
   â””â”€â–º System learns from:
       â”œâ”€â–º adherence_records (what user actually does)
       â”œâ”€â–º plan_change_events (manual modifications)
       â”œâ”€â–º day_overrides (approved/rejected adjustments)
       â””â”€â–º user_context_log (sleep, stress, soreness)
```

---

## ğŸ” Security Model

**Row Level Security (RLS) enabled on all tables:**

```sql
-- Pattern for all user-scoped tables:
CREATE POLICY "Users can only access their own data"
    ON table_name
    FOR ALL
    USING (auth.uid() = user_id);
```

**Service Role Bypass:**
- Backend uses service role key for admin operations
- RLS still enforces user isolation at query level
- Structured logging tracks all data access

---

## ğŸ“ˆ Scalability Considerations

### Indexes Strategy

**Critical Indexes (already in schema):**
```sql
-- User lookups
CREATE INDEX idx_profiles_user_id ON profiles(user_id);
CREATE INDEX idx_programs_user_id ON programs(user_id);

-- Date-based queries (most common)
CREATE INDEX idx_calendar_events_user_date ON calendar_events(user_id, date);
CREATE INDEX idx_activities_user_start ON activities(user_id, start_time DESC);
CREATE INDEX idx_meals_user_logged ON meals(user_id, logged_at DESC);

-- Adherence tracking
CREATE INDEX idx_adherence_records_created ON adherence_records(user_id, created_at DESC);

-- Program planning
CREATE INDEX idx_session_instances_program_week ON session_instances(program_id, week_index);
CREATE INDEX idx_meal_instances_program_week_day ON meal_instances(program_id, week_index, day_index);
```

### Partitioning Strategy (Future)

```sql
-- Partition large tables by date for performance
-- Examples:
-- - activities (by start_time)
-- - meals (by logged_at)
-- - adherence_records (by created_at)
-- - calendar_events (by date)
```

---

## ğŸš€ Next Steps

### Immediate Actions:
1. âœ… Run migration `039_program_planning_tables.sql`
2. âœ… Verify all 11 new tables created
3. âœ… Test consultation â†’ program generation flow
4. âœ… Verify RLS policies working

### Future Enhancements:
- Add materialized views for common aggregations
- Implement table partitioning for high-volume tables
- Add audit triggers for sensitive operations
- Create backup/restore procedures

---

**Schema Version:** 1.0.0 (Post-Migration 039)
**Last Updated:** 2025-10-16
**Total Tables:** ~38 tables across 6 subsystems
